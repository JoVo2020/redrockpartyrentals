APPS SCRIPT Backup

function doGet(e) {
  const action = (e && e.parameter && e.parameter.action || '').toLowerCase();
  let result;

  try {
    switch (action) {
      case 'inventory':
        result = getInventory_();
        break;
      default:
        result = { success: false, error: 'Unknown or missing ?action=' };
    }
    return ContentService
      .createTextOutput(JSON.stringify(result, null, 2))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ success:false, error: String(err) }, null, 2))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Adjust the sheet name to your tab's exact title
function getInventory_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Inventory');
  const values = sheet.getDataRange().getValues();
  const header = values[0];
  const rows = values.slice(1);

  const items = [];
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    if (!row[0]) continue; // skip blank rows
    const obj = {};
    for (let j = 0; j < header.length; j++) obj[header[j]] = row[j];
    items.push(obj);
  }
  return { success: true, count: items.length, inventory: items };
}




//POSTING ORDERS
/**
 * Red Rock Party Rentals
 * POST JSON -> Append order items to Orders2
 *
 * Orders2 columns (in this exact order):
 * Customer_Name | Order_ID | Item_ID | Quantity | Dropoff_Date | Pickup_Date
 */

const Post_Order_Config = {
  sheetName: "Orders2",
  headers: [
    "Customer_Name",
    "Order_ID",
    "Item_ID",
    "Quantity",
    "Dropoff_Date",
    "Pickup_Date"
  ]
};

function doPost(e) {
  const action = String((e?.parameter?.action) || (e?.parameters?.action?.[0]) || "").toLowerCase();

  if (action === "addorder") {
    return add_order_(e);
  }

  return jsonResponse_({ ok: false, error: "Unknown or missing ?action=" + action }, 400);
}




function add_order_(e) {
  try {
    const body = parseOrderRequest_(e);  // <-- NEW (JSON OR params)
    const payload = normalizePostOrderPayload_(body);
    validatePostOrderPayload_(payload);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(Post_Order_Config.sheetName);
    if (!sheet) throw new Error(`Sheet not found: ${Post_Order_Config.sheetName}`);

    ensurePostOrderHeaders_(sheet);

    const orderId = payload.orderId || Utilities.getUuid();

    const rows = payload.items.map(item => ([
      payload.customerName,
      orderId,
      item.itemId,
      item.quantity,
      payload.dropoffDate,
      payload.pickupDate
    ]));

    const startRow = sheet.getLastRow() + 1;
    sheet.getRange(startRow, 1, rows.length, Post_Order_Config.headers.length).setValues(rows);

    return jsonResponse_({ ok: true, orderId, rowsAdded: rows.length });

  } catch (err) {
    return jsonResponse_({ ok: false, error: String(err?.message || err) }, 400);
  }
}


/* ---------------- Helpers ---------------- */

function normalizePostOrderPayload_(obj) {
  return {
    customerName: String(obj.customerName ?? "").trim(),
    orderId: obj.orderId ? String(obj.orderId).trim() : "",
    dropoffDate: String(obj.dropoffDate ?? "").trim(),
    pickupDate: String(obj.pickupDate ?? "").trim(),

    // items: [{ itemId, quantity }]
    items: Array.isArray(obj.items)
      ? obj.items.map(it => ({
          itemId: String(it.itemId ?? "").trim(),
          quantity: Number(it.quantity ?? 0)
        }))
      : []
  };
}

function validatePostOrderPayload_(p) {
  if (!p.customerName) throw new Error("customerName is required");
  if (!p.dropoffDate) throw new Error("dropoffDate is required");
  if (!p.pickupDate) throw new Error("pickupDate is required");

  if (!Array.isArray(p.items) || p.items.length === 0) {
    throw new Error("items must be a non-empty array");
  }

  p.items.forEach((item, idx) => {
    if (!item.itemId) {
      throw new Error(`items[${idx}].itemId is required`);
    }
    if (!Number.isFinite(item.quantity) || item.quantity <= 0) {
      throw new Error(`items[${idx}].quantity must be a positive number`);
    }
  });
}

function ensurePostOrderHeaders_(sheet) {
  const existing = sheet
    .getRange(1, 1, 1, Post_Order_Config.headers.length)
    .getValues()[0];

  const matches = Post_Order_Config.headers.every(
    (h, i) => String(existing[i] || "").trim() === h
  );

  if (!matches) {
    sheet
      .getRange(1, 1, 1, Post_Order_Config.headers.length)
      .setValues([Post_Order_Config.headers]);
  }
}

function jsonResponse_(obj, statusCode) {
  if (statusCode) obj.status = statusCode;
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function parseOrderRequest_(e) {
  const params = e?.parameter || {};

  // Use params ONLY if they include real order fields (not just action)
  const hasOrderParams =
    typeof params.customerName === "string" ||
    typeof params.dropoffDate === "string" ||
    typeof params.pickupDate === "string" ||
    typeof params.items === "string";

  if (hasOrderParams) {
    let items = params.items;

    // Zoho will typically send items as a JSON string
    if (typeof items === "string") {
      try { items = JSON.parse(items); } catch { /* keep as-is */ }
    }

    return {
      customerName: params.customerName,
      orderId: params.orderId,
      dropoffDate: params.dropoffDate,
      pickupDate: params.pickupDate,
      items: items
    };
  }

  // Otherwise: JSON body (PowerShell, most normal clients)
  if (!e?.postData?.contents) throw new Error("Missing request body (no JSON and no parameters)");
  try {
    return JSON.parse(e.postData.contents);
  } catch {
    throw new Error("Invalid JSON body");
  }
}



// END POSTING ORDERS