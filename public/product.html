<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-N67L88MK');</script>
	<!-- End Google Tag Manager -->
	
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Red Rock Party Rentals</title>
	
	<!-- style sheets -->
	<link rel="stylesheet" href="style.css" />
	<link rel="stylesheet" href="book-now-component.css" />
	<link rel="stylesheet" href="accordion.css" />
	<link rel="stylesheet" href="cart.css" />
	
	<!-- Lora font for all text -->
	<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400&display=swap" rel="stylesheet">
	
	<!-- datepicker -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

	<!-- web icons -->
	<link rel="icon" href="/images/other-assets/favicon.ico" sizes="any">
	<link rel="icon" type="image/png" href="/images/other-assets/favicon.png">
	<link rel="icon" type="image/svg+xml" href="/images/other-assets/favicon.svg">
	<link rel="apple-touch-icon" href="/images/other-assets/apple-touch-icon.png">
	

  <style>
    .product-wrapper {
      max-width: 1100px;
      margin: 60px auto;
      padding: 20px;
      display: grid;
      gap: 40px;
    }

    @media (min-width: 900px) {
      .product-wrapper {
        grid-template-columns: 1fr 1fr;
      }
    }

    .product-image img {
      width: 100%;
	  max-width:600px;
      border-radius: 6px;
      object-fit: cover;
    }

    .product-title {
      font-size: 40px;
      color: #8b0000;
      margin-bottom: 10px;
    }

    .product-price {
      font-size: 26px;
      color: #505050;
      margin-bottom: 20px;
    }

    .availability-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .badge-neutral {
      background: #f3f3f3;
      color: #555;
    }

    .badge-success {
      background: #e6f5ea;
      color: #2c7a3f;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .qty-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .qty-row input {
      width: 60px;
      text-align: center;
      font-size: 18px;
    }

    .btn-primary {
      background: #8b0000;
      color: #fff;
      padding: 14px 22px;
      border: none;
      cursor: pointer;
      font-size: 18px;
    }

    .event-date-bar {
      background: #f5f5f5;
      padding: 15px;
      text-align: center;
      font-size: 18px;
    }
  </style>
</head>

<body>

<header>
  <nav class="navbar">
    <div class="logo">
      <a href="index.html">
        <img src="images/logo.png"/>
        <span style="color:#000;">Red Rock Party Rentals</span>
      </a>
    </div>
  </nav>
</header>

<section class="booking-form" style="margin:0 auto 20px auto;max-width:850px;">
  <div class="form-section" style="background-color:#eee;padding:15px;">
    <div class="form-container" style="display:flex;flex-wrap:wrap;gap:1rem;">
      <div class="dropdown-wrapper" style="width:100%;max-width:100%;">
        <div class="dropdown-icon-calendar"></div>
        <div class="dropdown-divider"></div>
        <input type="text" id="dateStartProduct" placeholder="Select Event Date">
      </div>
    </div>
  </div>
</section>


<div class="product-wrapper">
  <div class="product-image">
    <img id="productImage"/>
  </div>

  <div>
    <div class="product-title" id="productName"></div>
    <div class="product-price" id="productPrice"></div>
	
    <div style="margin-top:5px; font-size:18px; color:#505050;">
      <div id="productDescription"></div>
    </div>	
	
    <div id="availabilityBadge" class="availability-badge badge-neutral" style="display:none;"></div>

	
	<div style="display:flex;gap:5px;">	
		<div class="cart-qty">
		  <button id="qtyMinus">−</button>

		  <input
			id="qtyInput"
			type="number"
			min="1"
			step="1"
			value="1"
			class="cart-qty-input"
			onkeydown="if (event.key === 'Enter') this.blur()"
		  />

		  <button id="qtyPlus">+</button>
		</div>
			
		

		<button class="btn-primary" id="addBtn">
		  Add to Cart
		</button>
	</div>

  </div>
</div>


	
	<!-- CART OVERLAY -->
	<div id="cartOverlay" class="cart-overlay">
	  <div class="cart-panel cart-panel--fullscreen">

		<header class="cart-header">
		  <button class="cart-back" style="font-size:30px;" onclick="closeCart()">←</button>
		  <h2 style="margin-bottom:0;font-size:30px;">Cart</h2>
		  <button class="cart-close" onclick="closeCart()">✕</button>
		</header>


		<section class="booking-form" style="margin-bottom:0px;padding:0px;">
			<div id="cart-panel-booking-form" class="form-section" style="background-color:transparent; padding:0px;max-width:100%;">
				<form class="form-container" style="display:flex; flex-wrap:wrap;gap:1rem;background-color: #eee;padding: 15px;">
				  <div class="dropdown-wrapper" style="width:100%;max-width:100%;">
					<div class="dropdown-icon-calendar"></div>
					<div class="dropdown-divider"></div>
					<input type="text" id="dateStart2" placeholder="Select Event Date" required>
				  </div>
				</form>
			</div>
		</section>
		
		<div style="background-color:#eee;">
			<div id="CheckingAvailabilityNote" class="checking-availability-message" style="display:none;">
				Checking availability…
			</div>		
		</div>
		
		<div id="cartItems" class="cart-items"></div>

		<footer class="cart-footer">
		  <div class="cart-summary">
			<div class="cart-line">
			  <span>Delivery</span>
			  <strong id="cartSubtotal">$10.00</strong>
			</div>
			<div class="cart-line total">
			  <span>Total</span>
			  <strong id="cartTotal">$0.00</strong>
			</div>
		  </div>

			<div class="button-row" style="display:flex;gap:10px;">
			  <button class="back-btn" onclick="closeCart()">Continue Shopping</button>
			  <button id="checkoutBtn" class="checkout-btn" onclick="goToCheckout()">Checkout →</button>
			</div>		
		</footer>

	  </div>
	</div>


	
	
<script src="navbar-scroll.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="product_data.js"></script>
<script src="availabilityService.js"></script>
<script src="cart.js"></script>
<script src="book-now-component.js"></script>
<script src="checkout.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  const params = new URLSearchParams(window.location.search);
  const productId = params.get('id');

  // ----------------------------
  // STATIC PRODUCT DATA
  // ----------------------------
	const item = window.PRODUCT_DATA.find(
	  p => p.Product_ID === productId
	);
	
  if (!item) {
    document.body.innerHTML = "<h2>Product not found</h2>";
    return;
  }

  // ----------------------------
  // RENDER STATIC DATA INSTANTLY
  // ----------------------------
  // Render instantly (no API calls)
  document.getElementById('productName').textContent =
    item["Item Name"];

  document.getElementById('productPrice').textContent =
    "$" + item["Rental Price"].toFixed(2) + " each";

  document.getElementById('productImage').src =
    item["Image"];

  document.getElementById('productDescription').textContent =
    item["Item Description"];

  const badge = document.getElementById('availabilityBadge');
  const addBtn = document.getElementById('addBtn');
  const qtyInput = document.getElementById('qtyInput');

  // ----------------------------
  // CHECK IF DATE EXISTS
  // ----------------------------
  const dates = AvailabilityService.getRentalDates();

  if (!dates) {

    badge.textContent =
      "Event date not selected";
    badge.className =
      "availability-badge badge-neutral";

  } else {

    // ONLY NOW call availability
    try {

      const availability =
        await AvailabilityService.ensureAvailability();

      const liveItem =
        availability ? availability[item.id] : null;

      if (liveItem) {

        badge.textContent =
          liveItem.availableQty + " available";
        badge.className =
          "availability-badge badge-success";

        qtyInput.max =
          liveItem.availableQty;

      } else {

        badge.textContent =
          "Availability unavailable";
        badge.className =
          "availability-badge badge-warning";

      }

    } catch (err) {

      badge.textContent =
        "Availability unavailable";
      badge.className =
        "availability-badge badge-warning";

    }
  }

  // ----------------------------
  // ADD TO CART (ALWAYS ALLOWED)
  // ----------------------------
  addBtn.addEventListener('click', () => {

    const qty =
      parseInt(qtyInput.value) || 1;

    addToCart({
      id: item["Product_ID"],
      name: item["Item Name"],
      price: item["Rental Price"],
      image: item["Image"],
      availableQty: 9999, // unrestricted until availability checked
      qty: qty
    });

  });

});

const qtyInput = document.getElementById("qtyInput");
const minusBtn = document.getElementById("qtyMinus");
const plusBtn = document.getElementById("qtyPlus");

minusBtn.addEventListener("click", () => {
  let current = parseInt(qtyInput.value) || 1;
  if (current > 1) {
    qtyInput.value = current - 1;
  }
});

plusBtn.addEventListener("click", () => {
  let current = parseInt(qtyInput.value) || 1;
  qtyInput.value = current + 1;
});


const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);

flatpickr("#dateStartProduct", {
  disableMobile: true,
  dateFormat: "m/d/Y",
  minDate: tomorrow,

  onChange: async function(selectedDates, dateStr) {

    if (!dateStr) return;

    const [month, day, year] = dateStr.split('/');
    const iso = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;

    AvailabilityService.setRentalDates(iso);

    // Sync cart calendar
    const cartInput = document.getElementById("dateStart2");
    if (cartInput) cartInput.value = dateStr;

    // Get fresh availability
    const availability = await AvailabilityService.ensureAvailability();
    const liveItem = availability?.[productId];

    if (liveItem) {
      badge.textContent = liveItem.availableQty + " available";
      badge.className = "availability-badge badge-success";
      badge.style.display = "inline-block";
      qtyInput.max = liveItem.availableQty;
    }

    refreshCartAvailability();
    renderCart();
  }
});



document.addEventListener("DOMContentLoaded", () => {

  const params = new URLSearchParams(window.location.search);
  const urlDate = params.get("date");

  if (!urlDate) return;

  const [year, month, day] = urlDate.split("-");
  const formatted = `${month}/${day}/${year}`;

  const input = document.getElementById("dateStartProduct");
  if (input) input.value = formatted;

});

</script>

</body>
</html>